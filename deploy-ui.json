{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
      "config": {
        "basics": {
            "description": "Deploy the SQL Arc Single Pane of Glass Workbooks. If you are updating existing deployments please make sure you select the same subscription and resource group."
        }
      },
      "basics": [
        {
            "name": "updateDeployment",
            "type": "Microsoft.Common.CheckBox",
            "label": "Are you updating an existing deployment?"
        }
      ],
      "steps": [
        {
            "name": "deploymentConfig",
            "label": "Deployment Configuration",
            "elements": [
                {
                    "name": "newDeploymentSection",
                    "type": "Microsoft.Common.Section",
                    "label": "New Deployment",
                    "visible": "[equals(basics('updateDeployment'), false)]",
                    "elements": [
                        {
                            "name": "newDeployText",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": true,
                            "options": {
                              "icon": "None",
                              "text": "Thank you for deploying the Arc Enabled SQL Workbooks. Since this is a new deployment no more information is needed! Push Next to Continue."
                            }
                          }
                    ]

                },
                {
                    "name": "updateDeploymentSection",
                    "type": "Microsoft.Common.Section",
                    "label": "Updating Deployment",
                    "visible": "[equals(basics('updateDeployment'), true)]",
                    "elements": [
                        {
                            "name": "workbooksApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                              "method": "GET",
                              "path": "[concat(subscription().id, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Insights/workbooks?category=workbook&api-version=2021-08-01')]"
                            }
                        },
                        {
                            "name": "hiddenArcPaneOfGlassLoad",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": false,
                            "options": {
                              "icon": "None",
                              "text": "[parse(concat('[\"', first(filter(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => contains(item.properties.displayName, 'Arc SQL Single Pane of Glass'))).properties.displayName, ' - ', first(filter(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => contains(item.properties.displayName, 'Arc SQL Single Pane of Glass'))).name, '\"]'))]"
                            }
                          },
                        {
                            "name": "paneOfGlassDropDown",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Current Single Pane of Glass Workbook",
                            "toolTip": "Your currently deployed version of the Single Pane of Glass Workbook, please select the correct deployment if the default is incorect.",
                            "defaultValue": "[parse(concat('[\"', first(filter(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => contains(item.properties.displayName, 'Arc SQL Single Pane of Glass'))).properties.displayName, ' - ', first(filter(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => contains(item.properties.displayName, 'Arc SQL Single Pane of Glass'))).name, '\"]'))]",
                            "constraints": {
                              "allowedValues": "[map(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => parse(concat('{\"label\":\"', item.properties.displayName, ' - ', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                              "required": true
                            },
                            "visible": true
                        },
                        {
                            "name": "hiddenSqlLicenseLoad",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": false,
                            "options": {
                              "icon": "None",
                              "text": "[parse(concat('[\"', first(filter(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => contains(item.properties.displayName, 'SQL Licensing Summary'))).properties.displayName, ' - ', first(filter(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => contains(item.properties.displayName, 'SQL Licensing Summary'))).name, '\"]'))]"
                            }
                          },
                        {
                            "name": "licenseSummaryDropDown",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Current SQL Licensing Summary Workbook",
                            "toolTip": "Your currently deployed version of the SQL Licensing Summary Workbook, please select the correct deployment if the default is incorect.",
                            "defaultValue": "[parse(concat('[\"', first(filter(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => contains(item.properties.displayName, 'SQL Licensing Summary'))).properties.displayName, ' - ', first(filter(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => contains(item.properties.displayName, 'SQL Licensing Summary'))).name, '\"]'))]",
                            "constraints": {
                              "allowedValues": "[map(steps('deploymentConfig').updateDeploymentSection.workbooksApi.value, (item) => parse(concat('{\"label\":\"', item.properties.displayName, ' - ', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                              "required": true
                            },
                            "visible": true
                        }
                    ]

                }
            ]
        }
      ],
      "outputs": {
		  "paneOfGlassGuid": "[if(equals(basics('updateDeployment'), true), steps('deploymentConfig').updateDeploymentSection.paneOfGlassDropDown.value, 'newDeployment')]",
          "licenseSummaryGuid": "[if(equals(basics('updateDeployment'), true), steps('deploymentConfig').updateDeploymentSection.licenseSummaryDropDown.value, 'newDeployment')]",
          "location": "[resourceGroup().location]"
	  }
    }
  }